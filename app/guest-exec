#!/usr/bin/env python3
"""Execute a command inside the QEMU guest via the QEMU Guest Agent.

Usage:
    guest-exec [--wait] "command args..."
    guest-exec [--wait] command arg1 arg2 ...

Options:
    --wait    Wait for guest agent to become available (retries for up to 60s).
              Useful when running immediately after VM boot.

Requires qemu-guest-agent running inside the VM and a virtio channel
configured in the libvirt domain XML.
"""

import base64
import json
import subprocess
import sys
import time

POLL_INTERVAL = 0.3   # seconds between guest-exec-status polls
POLL_TIMEOUT = 300     # maximum seconds to wait for command completion
AGENT_WAIT_TIMEOUT = 60   # seconds to wait for guest agent when --wait is used
AGENT_WAIT_INTERVAL = 2   # seconds between agent connection retries


class AgentNotConnectedError(Exception):
    """Raised when the guest agent is not connected."""


def virsh_qga(domain: str, command: dict) -> dict:
    """Send a QMP command to the QEMU Guest Agent via virsh."""
    cmd_json = json.dumps(command)
    result = subprocess.run(
        ["virsh", "qemu-agent-command", domain, cmd_json],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        stderr = result.stderr.strip()
        if "agent is not connected" in stderr or "not connected" in stderr.lower():
            raise AgentNotConnectedError(stderr)
        print(f"Error: virsh qemu-agent-command failed:\n{stderr}", file=sys.stderr)
        sys.exit(1)
    return json.loads(result.stdout)


def wait_for_agent(domain: str, timeout: float = AGENT_WAIT_TIMEOUT) -> None:
    """Poll until the guest agent responds to a ping."""
    deadline = time.monotonic() + timeout
    attempt = 0
    while time.monotonic() < deadline:
        attempt += 1
        remaining = int(deadline - time.monotonic())
        try:
            virsh_qga(domain, {"execute": "guest-ping"})
            return
        except AgentNotConnectedError:
            print(
                f"\r  Waiting for guest agent... ({remaining}s remaining)",
                end="", file=sys.stderr, flush=True,
            )
            time.sleep(AGENT_WAIT_INTERVAL)
    print("", file=sys.stderr)  # newline after progress
    print(
        "Error: QEMU Guest Agent did not become available within "
        f"{int(timeout)}s.\n"
        "  Possible causes:\n"
        "    - The VM is still booting (try increasing --wait timeout)\n"
        "    - qemu-guest-agent is not installed inside the VM\n"
        "    - The virtio channel is not configured",
        file=sys.stderr,
    )
    sys.exit(127)


def get_domain_name() -> str:
    """Get the name of the running libvirt domain (expects exactly one)."""
    result = subprocess.run(
        ["virsh", "list", "--name", "--state-running"],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        print("Error: failed to list running domains.", file=sys.stderr)
        sys.exit(1)
    names = [n for n in result.stdout.strip().splitlines() if n.strip()]
    if not names:
        print("Error: no running VM found.", file=sys.stderr)
        sys.exit(1)
    return names[0].strip()


def main() -> None:
    wait_mode = False
    argv = sys.argv[1:]
    if argv and argv[0] == "--wait":
        wait_mode = True
        argv = argv[1:]

    if not argv:
        print(
            f"Usage: {sys.argv[0]} [--wait] <command> [args...]\n"
            "\n"
            "Options:\n"
            "  --wait  Wait for guest agent to become available (up to 60s)",
            file=sys.stderr,
        )
        sys.exit(1)

    # Support both: guest-exec "uname -a" and guest-exec uname -a
    if len(argv) == 1 and " " in argv[0]:
        path = "/bin/sh"
        args = ["-c", argv[0]]
    else:
        path = argv[0]
        args = argv[1:]

    domain = get_domain_name()

    if wait_mode:
        wait_for_agent(domain)

    # Execute command via guest-exec
    exec_cmd = {
        "execute": "guest-exec",
        "arguments": {
            "path": path,
            "arg": args,
            "capture-output": True,
        },
    }
    try:
        resp = virsh_qga(domain, exec_cmd)
    except AgentNotConnectedError:
        print(
            "Error: QEMU Guest Agent is not running or not connected.\n"
            "  Hint: If the VM just started, wait a few seconds and retry.\n"
            "        Or use --wait to auto-retry:\n"
            f"          {sys.argv[0]} --wait <command>\n"
            "  Ensure qemu-guest-agent is installed and running inside the VM.",
            file=sys.stderr,
        )
        sys.exit(127)

    pid = resp.get("return", {}).get("pid")
    if pid is None:
        print("Error: guest-exec did not return a PID.", file=sys.stderr)
        sys.exit(1)

    # Poll for completion
    status_cmd = {
        "execute": "guest-exec-status",
        "arguments": {"pid": pid},
    }
    deadline = time.monotonic() + POLL_TIMEOUT
    while True:
        try:
            status = virsh_qga(domain, status_cmd)
        except AgentNotConnectedError:
            print(
                "Error: Guest agent disconnected while waiting for command result.",
                file=sys.stderr,
            )
            sys.exit(1)
        ret = status.get("return", {})
        if ret.get("exited"):
            break
        if time.monotonic() > deadline:
            print(
                f"Error: command did not complete within {POLL_TIMEOUT}s.",
                file=sys.stderr,
            )
            sys.exit(1)
        time.sleep(POLL_INTERVAL)

    # Decode and output stdout/stderr
    out_b64 = ret.get("out-data", "")
    err_b64 = ret.get("err-data", "")
    if out_b64:
        sys.stdout.buffer.write(base64.b64decode(out_b64))
        sys.stdout.buffer.flush()
    if err_b64:
        sys.stderr.buffer.write(base64.b64decode(err_b64))
        sys.stderr.buffer.flush()

    exit_code = ret.get("exitcode", 0)
    sys.exit(exit_code)


if __name__ == "__main__":
    main()
